stages:
  - install
  - lint
  - test
  - build

# define yaml anchors for frontend and backend before_script
.change_to_frontend_dir: &change_to_frontend_dir
  before_script:
    - cd frontend

.change_to_backend_dir: &change_to_backend_dir
  before_script:
    - cd backend

# frontend jobs
cache: # cache node_modules
  paths:
    - frontend/node_modules/

frontend_install:
  stage: install
  image: node:20
  tags:
    - frontend
  <<: *change_to_frontend_dir
  script:
    - echo "Cleaning installed the dependency..."
    - rm -rf node_modules
    - npm ci
    - echo "Installed!"
  rules:
    - changes:
      - frontend/**/*

frontend_lint:
  stage: lint
  image: node:20
  tags:
    - frontend
  <<: *change_to_frontend_dir
  script:
    - echo "Linting code..."
    - npm run lint
    - echo "Lint passed!"
  rules:
    - changes:
      - frontend/**/*

frontend_test:
  stage: test
  image: node:20
  tags:
    - frontend
  <<: *change_to_frontend_dir
  script:
    - echo "Running unit tests..."
    - npm test
    - echo "All test passed!"
  rules:
    - changes:
      - frontend/**/*

frontend_build:
  stage: build
  image: node:20
  tags:
    - frontend
  <<: *change_to_frontend_dir
  script:
    - echo "Building application..."
    - npm run build
    - echo "Built!"
    - ls
  rules:
    - changes:
      - frontend/**/*

# backend jobs
backend_lint:
  stage: lint
  image: python:3.10
  tags:
    - backend
  <<: *change_to_backend_dir
  script:
    - pip install flake8
    - flake8 . --max-line-length=120
  rules:
    - changes:
      - backend/**/*

backend_test:
  stage: test
  image: python:3.10
  tags:
    - backend
  <<: *change_to_backend_dir
  script:
    - pip install -r backend/requirements.txt
    - pytest test/test_main.py  # Run backend service tests
    - pytest test/test_db.py  # Run database tests
    - pytest test/test_integration.py  # Run integration tests
    - pytest test/test_analysis.py  # Run analytics tests
  rules:
    - changes:
      - backend/**/*
